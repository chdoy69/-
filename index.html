<!--
[YouTube ì˜ìƒ ì¡°íšŒ + í•„í„°/ë‚´ë³´ë‚´ê¸°] (ë‹¨ì¼ index.html)

âœ… ê¸°ëŠ¥
- YouTube Data API v3ë¡œ ì˜ìƒ ê²€ìƒ‰(search.list) â†’ ìƒì„¸(videos.list) â†’ ì±„ë„(channels.list) í•©ì¹˜ê¸°
- í•„í„°: ìˆí¼/ë¡±í¼(60ì´ˆ ê¸°ì¤€), ê¸°ê°„(1ê°œì›”/3ê°œì›”/6ê°œì›”/1ë…„/ì „ì²´)
- ì •ë ¬: ì¡°íšŒìˆ˜ ë§ì€ ì˜ìƒ / ì¢‹ì•„ìš” ë§ì€ ì˜ìƒ / êµ¬ë…ì ë§ì€ ì˜ìƒ(ì±„ë„ êµ¬ë…ì ìˆ˜ ê¸°ì¤€)
- ì¹´ë“œ/í…Œì´ë¸” ë³´ê¸° ì „í™˜
- ìƒì„¸ íŒ¨ë„ì—ì„œ ì˜ìƒ ì¬ìƒ(YouTube embed iframe)
- CSV(UTF-8 BOM)ë¡œ â€œì—‘ì…€ í•œê¸€ ê¹¨ì§ ë°©ì§€â€ ë‹¤ìš´ë¡œë“œ
- JSON ë³´ê¸°(ì›ë³¸ ì‘ë‹µ í™•ì¸)

[ì‚¬ìš©ë²•]
1) Google Cloud Console â†’ YouTube Data API v3 í™œì„±í™” â†’ API Key ë°œê¸‰
2) ì´ í˜ì´ì§€ì—ì„œ API Key ì…ë ¥ â†’ â€œí‚¤ ì €ì¥â€
3) ê²€ìƒ‰ì–´ ì…ë ¥ â†’ ê²€ìƒ‰
4) GitHub Pages(HTTPS)ì—ì„œ ì‹¤í–‰ ê¶Œì¥

[ì£¼ì˜]
- search.listì—ëŠ” tags/statistics/durationì´ ì—†ìŒ â†’ videos.listë¡œ ë°˜ë“œì‹œ ì¡°íšŒ
- subscriberCountëŠ” channels.listë¡œ ì¡°íšŒ
-->

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YouTube ì˜ìƒ ì¡°íšŒ + í•„í„°/ë‚´ë³´ë‚´ê¸°</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f1733; --card:#121b3b;
      --text:#e8ecff; --muted:#9fb0ff; --sub:#c9d2ff;
      --line:rgba(255,255,255,.12); --acc:#6aa6ff;
      --bad:#ff6a6a; --ok:#53e3a6; --warn:#ffd36a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:16px; --r2:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial;
      background: radial-gradient(1000px 600px at 10% 10%, rgba(106,166,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(83,227,166,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--acc); text-decoration:none}
    a:hover{text-decoration:underline}

    .wrap{max-width:1200px; margin:0 auto; padding:16px 16px 36px;}
    h1{margin:0; font-size:18px; letter-spacing:-.3px}
    .hint{color:var(--muted); font-size:12px; line-height:1.45; margin-top:6px}

    .sticky{
      position:sticky; top:0; z-index:10;
      background: rgba(11,16,32,.75);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      padding:10px 0;
      margin-bottom:12px;
    }
    .sticky .inner{
      max-width:1200px; margin:0 auto; padding:0 16px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(18,27,59,.55);
      color:var(--sub); font-size:12px;
    }
    .pill strong{color:var(--text)}

    .btn{
      border:1px solid var(--line);
      background:rgba(18,27,59,.70);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow: var(--shadow);
    }
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn.primary{background:rgba(106,166,255,.18); border-color:rgba(106,166,255,.35)}
    .btn.danger{background:rgba(255,106,106,.14); border-color:rgba(255,106,106,.35)}
    .btn.ghost{box-shadow:none; background:transparent}
    .btn:disabled{opacity:.45; cursor:not-allowed; box-shadow:none}

    /* === Layout: ìœ„/ì•„ë˜ êµ¬ì„± === */
    .grid{display:grid; grid-template-columns:1fr; gap:12px; align-items:start;}

    .panel{
      border:1px solid var(--line);
      background: rgba(15,23,51,.65);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(18,27,59,.55);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .panel .hd .title{font-weight:950; font-size:14px}
    .panel .bd{padding:14px}

    label{display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted)}
    input, select{
      width:100%;
      border:1px solid var(--line);
      background: rgba(18,27,59,.65);
      color:var(--text);
      padding:10px 11px;
      border-radius:12px;
      outline:none;
    }
    input:focus, select:focus{border-color:rgba(106,166,255,.45)}
    .fields{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width:680px){.fields{grid-template-columns:1fr}}
    .small{font-size:12px; color:var(--muted); line-height:1.45}

    .notice{
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(255,211,106,.10);
      border-radius: 14px;
      padding:10px 12px;
      color:#ffe7b3; font-size:12px; line-height:1.45;
    }
    .err{
      border:1px dashed rgba(255,106,106,.35);
      background: rgba(255,106,106,.10);
      border-radius:14px;
      padding:10px 12px;
      color:#ffd0d0; font-size:12px; line-height:1.45;
    }

    /* === Results: ë°˜ì‘í˜• ê°€ë¡œ ê·¸ë¦¬ë“œ === */
    .list{
      display:grid;
      gap:12px;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }
    .card{
      border:1px solid var(--line);
      background: rgba(18,27,59,.62);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
      cursor:pointer;
      display:flex;
      flex-direction:column;
    }
    .thumb{background: rgba(0,0,0,.25); overflow:hidden; aspect-ratio: 16/9;}
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .meta{padding:12px; display:flex; flex-direction:column; gap:8px}
    .titleline{font-weight:950; font-size:14px; line-height:1.35}
    .subline{color:var(--muted); font-size:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .desc{color:var(--sub); font-size:12px; line-height:1.45; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    .chip{
      font-size:11px; padding:5px 8px; border-radius:999px;
      border:1px solid var(--line); background: rgba(15,23,51,.65);
      color:var(--sub);
    }
    .chip.acc{border-color: rgba(106,166,255,.35); background: rgba(106,166,255,.12); color:#d3e6ff}
    .chip.bad{border-color: rgba(255,106,106,.35); background: rgba(255,106,106,.12); color:#ffd0d0}

    .statrow{display:flex; gap:8px; flex-wrap:wrap}
    .stat{
      font-size:12px; color:var(--sub);
      border:1px solid var(--line);
      background: rgba(15,23,51,.55);
      padding:6px 9px; border-radius:12px;
    }

    .detailTitle{font-weight:950; font-size:15px; line-height:1.35; margin:0 0 6px}
    .kv{display:grid; grid-template-columns: 130px 1fr; gap:6px; font-size:12px}
    .kv div{padding:6px 0; border-bottom:1px solid rgba(255,255,255,.08)}
    .kv .k{color:var(--muted)}
    .kv .v{color:var(--text); word-break:break-word}

    .json{
      margin-top:10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.28);
      border-radius:14px;
      padding:10px;
      max-height:260px;
      overflow:auto;
      white-space:pre;
      font-size:11px;
      color:#dbe3ff;
      display:none;
    }
    .spinner{
      width:18px; height:18px;
      border:2px solid rgba(255,255,255,.20);
      border-top-color: rgba(106,166,255,.85);
      border-radius:999px;
      animation: spin 0.8s linear infinite;
      display:none;
    }
    @keyframes spin {to{transform:rotate(360deg)}}
  </style>
</head>
<body>

<div class="sticky">
  <div class="inner">
    <div>
      <h1>YouTube ì˜ìƒ ì¡°íšŒ + í•„í„°/ë‚´ë³´ë‚´ê¸°</h1>
      <div class="hint">ê²€ìƒ‰ â†’ tags/statistics/duration(videos.list) + subscriberCount(channels.list) í•©ì³ì„œ í‘œì‹œ Â· CSV(UTF-8 BOM)ë¡œ â€œì—‘ì…€ í•œê¸€ ê¹¨ì§ ë°©ì§€â€</div>
    </div>

    <div class="row">
      <button class="btn" id="exportBtn" title="í˜„ì¬ í•„í„° ì ìš© ê²°ê³¼ë¥¼ ì—‘ì…€(CSV)ë¡œ ì €ì¥">
        â¬‡ï¸ ì—‘ì…€ë¡œ ì €ì¥(í•œê¸€ OK)
      </button>
      <button class="btn" id="viewToggleBtn">ì¹´ë“œ/í…Œì´ë¸”</button>
      <button class="btn ghost" id="jsonToggleBtn">JSON ë³´ê¸°</button>
      <span class="pill" id="countPill"><strong>0</strong>ê°œ</span>
      <span class="pill" id="statusPill">ëŒ€ê¸°</span>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="grid">

    <!-- SEARCH PANEL -->
    <div class="panel">
      <div class="hd">
        <div class="title">ê²€ìƒ‰ / í•„í„°</div>
        <div class="row">
          <button class="btn ghost" id="resetBtn">ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="bd">

        <div class="fields">
          <label>
            YouTube API Key
            <input id="apiKey" placeholder="AIza..." autocomplete="off"/>
            <div class="row">
              <button class="btn primary" id="saveKeyBtn">í‚¤ ì €ì¥</button>
              <button class="btn danger" id="delKeyBtn">í‚¤ ì‚­ì œ</button>
            </div>
            <div class="small">ê¶Œì¥: Google Cloud Consoleì—ì„œ HTTP referrer ì œí•œì— GitHub Pages ë„ë©”ì¸ ë“±ë¡</div>
          </label>

          <label>
            ê²€ìƒ‰ì–´
            <input id="query" placeholder="ì˜ˆ) AI, ë‡Œê³¼í•™, ì‡¼ì¸ " />
            <div class="small">â€» ì´ ë²„ì „ì€ â€œì˜ìƒ(video)â€ ê²€ìƒ‰ì„ ê¸°ì¤€ìœ¼ë¡œ ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</div>
          </label>
        </div>

        <div style="height:10px"></div>

        <div class="fields">
          <label>
            ê²°ê³¼ ìˆ˜(í˜ì´ì§€)
            <select id="maxResults">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
            </select>
          </label>

          <label>
            ì •ë ¬
            <select id="sortMode">
              <option value="views_desc" selected>ì¡°íšŒìˆ˜ ë§ì€ ì˜ìƒ</option>
              <option value="likes_desc">ì¢‹ì•„ìš” ë§ì€ ì˜ìƒ</option>
              <option value="subs_desc">êµ¬ë…ì ë§ì€ ì˜ìƒ</option>
            </select>
          </label>

          <label>
            ìˆí¼/ë¡±í¼
            <select id="lenFilter">
              <option value="all" selected>ì „ì²´</option>
              <option value="short">ìˆí¼ (60ì´ˆ ë¯¸ë§Œ)</option>
              <option value="long">ë¡±í¼ (60ì´ˆ ì´ìƒ)</option>
            </select>
          </label>

          <label>
            ê¸°ê°„(ì—…ë¡œë“œ)
            <select id="periodFilter">
              <option value="all" selected>ì „ì²´</option>
              <option value="1m">1ê°œì›”</option>
              <option value="3m">3ê°œì›”</option>
              <option value="6m">6ê°œì›”</option>
              <option value="1y">1ë…„</option>
            </select>
          </label>

          <label>
            ê²€ìƒ‰ íƒ€ì…
            <select id="searchType" disabled>
              <option value="video" selected>ì˜ìƒ(video)</option>
            </select>
            <div class="small">í˜„ì¬ ìš”ì²­ì‚¬í•­(ê¸°ê°„ë³„ TOP ì •ë ¬)ì€ ì˜ìƒ ê¸°ì¤€ìœ¼ë¡œ êµ¬í˜„ë˜ì–´ ìˆì–´ ì˜ìƒ ê²€ìƒ‰ë§Œ ê³ ì •í•©ë‹ˆë‹¤.</div>
          </label>
        </div>

        <div style="height:12px"></div>

        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button class="btn primary" id="searchBtn">
              <span class="spinner" id="spin"></span>
              ê²€ìƒ‰
            </button>
            <button class="btn" id="applyBtn">í•„í„° ì ìš©</button>
          </div>
          <div class="row">
            <button class="btn" id="prevBtn" disabled>ì´ì „ í˜ì´ì§€</button>
            <button class="btn" id="nextBtn" disabled>ë‹¤ìŒ í˜ì´ì§€</button>
          </div>
        </div>

        <div id="helpBox" class="notice" style="margin-top:12px; display:none"></div>
        <div id="errBox" class="err" style="margin-top:12px; display:none"></div>
        <div id="jsonBox" class="json"></div>
      </div>
    </div>

    <!-- RESULTS PANEL -->
    <div class="panel">
      <div class="hd">
        <div class="title">ê²°ê³¼</div>
        <div class="row">
          <button class="btn ghost" id="copyUrlBtn">ì„ íƒ URL ë³µì‚¬</button>
        </div>
      </div>
      <div class="bd">
        <div id="list" class="list"></div>
      </div>
    </div>

    <!-- DETAIL PANEL -->
    <div class="panel">
      <div class="hd">
        <div class="title">ìƒì„¸ (ì˜ìƒ ì¬ìƒ)</div>
        <div class="row">
          <button class="btn ghost" id="closeDetailBtn">ë‹«ê¸°</button>
        </div>
      </div>
      <div class="bd" id="detail">
        <div class="small">ëª©ë¡ì—ì„œ í•­ëª©ì„ í´ë¦­í•˜ë©´ ìƒì„¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>

  </div>
</div>

<script>
(() => {
  let viewMode = "card"; // card | table
  let itemsAll = [];
  let itemsFiltered = [];
  let selected = null;
  let lastRaw = null;

  const page = { next:null, prev:null };

  const $ = (s)=>document.querySelector(s);
  const LS_KEY = "ytViewer.key.v1";

  function setStatus(text, kind=""){
    const p = $("#statusPill");
    p.textContent = text;
    p.style.borderColor =
      kind==="ok" ? "rgba(83,227,166,.35)" :
      kind==="err" ? "rgba(255,106,106,.35)" :
      kind==="warn"? "rgba(255,211,106,.35)" :
      "rgba(255,255,255,.12)";
    p.style.background =
      kind==="ok" ? "rgba(83,227,166,.10)" :
      kind==="err" ? "rgba(255,106,106,.10)" :
      kind==="warn"? "rgba(255,211,106,.10)" :
      "rgba(18,27,59,.55)";
  }

  function showErr(msg){ $("#errBox").style.display = ""; $("#errBox").textContent = msg; }
  function hideErr(){ $("#errBox").style.display="none"; $("#errBox").textContent=""; }
  function showHelp(html){ $("#helpBox").style.display = ""; $("#helpBox").innerHTML = html; }
  function hideHelp(){ $("#helpBox").style.display="none"; $("#helpBox").innerHTML=""; }

  function esc(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function fmtNum(n){
    const x = Number(n);
    if(!Number.isFinite(x)) return "-";
    return x.toLocaleString("ko-KR");
  }
  function toDate(s){
    const d = new Date(s);
    return Number.isFinite(d.getTime()) ? d : null;
  }
  function fmtDate(d){
    if(!d) return "-";
    return d.toISOString().slice(0,10);
  }
  function clampStr(s, max=160){
    if(!s) return "";
    s = String(s).replace(/\s+/g," ").trim();
    return s.length > max ? s.slice(0,max-1) + "â€¦" : s;
  }

  function parseISODurationToSeconds(iso){
    if(!iso || typeof iso !== "string") return null;
    const m = iso.match(/P(?:([\d.]+)D)?T?(?:([\d.]+)H)?(?:([\d.]+)M)?(?:([\d.]+)S)?/);
    if(!m) return null;
    const days = parseFloat(m[1]||"0");
    const h = parseFloat(m[2]||"0");
    const min = parseFloat(m[3]||"0");
    const sec = parseFloat(m[4]||"0");
    const total = Math.round(days*86400 + h*3600 + min*60 + sec);
    return Number.isFinite(total) ? total : null;
  }
  function fmtSeconds(sec){
    if(sec == null || !Number.isFinite(sec)) return "-";
    const s = Math.max(0, Math.floor(sec));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const r = s%60;
    if(h>0) return `${h}:${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
    return `${m}:${String(r).padStart(2,"0")}`;
  }

  function getPeriodStart(period){
    if(period === "all") return null;
    const now = new Date();
    const d = new Date(now);
    if(period === "1m") d.setMonth(d.getMonth()-1);
    if(period === "3m") d.setMonth(d.getMonth()-3);
    if(period === "6m") d.setMonth(d.getMonth()-6);
    if(period === "1y") d.setFullYear(d.getFullYear()-1);
    return d;
  }

  function chip(label, cls=""){
    const span = document.createElement("span");
    span.className = "chip " + cls;
    span.textContent = label;
    return span;
  }
  function lenChip(sec){
    if(sec == null || !Number.isFinite(sec)) return chip("ê¸¸ì´ì—†ìŒ", "bad");
    return sec < 60 ? chip(`ìˆí¼ ${fmtSeconds(sec)}`, "acc") : chip(`ë¡±í¼ ${fmtSeconds(sec)}`);
  }

  async function fetchJSON(url, opts={}, timeoutMs=20000){
    const ctrl = new AbortController();
    const id = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(url, {...opts, signal: ctrl.signal});
      const text = await res.text();
      let json = null;
      try{ json = text ? JSON.parse(text) : null; } catch {}
      if(!res.ok){
        const msg = json?.error?.message || json?.message || `${res.status} ${res.statusText}`;
        const reason = json?.error?.errors?.[0]?.reason || "";
        return {ok:false, status:res.status, msg, reason, json, raw:text};
      }
      return {ok:true, status:res.status, json: json ?? {}, raw:text};
    } catch(e){
      const aborted = String(e?.name)==="AbortError";
      return {ok:false, status:0, msg: aborted ? "ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆì–´ìš”(Timeout)." : ("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ / CORS ì°¨ë‹¨ ê°€ëŠ¥: " + (e?.message||e)), reason:"", json:null};
    } finally {
      clearTimeout(id);
    }
  }

  function classifyYtError(res){
    const message = res.msg || "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    const reason = res.reason || "";
    if(res.status === 403 && /quota/i.test(message)) return "í• ë‹¹ëŸ‰(quota) ì´ˆê³¼ë¡œ ë³´ì…ë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, ë‹¤ë¥¸ í‚¤/í”„ë¡œì íŠ¸ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.";
    if(reason === "keyInvalid") return "API Keyê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. í‚¤ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.";
    if(reason === "accessNotConfigured") return "APIê°€ í”„ë¡œì íŠ¸ì—ì„œ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Google Cloud Consoleì—ì„œ YouTube Data API v3ë¥¼ í™œì„±í™”í•˜ì„¸ìš”.";
    if(/referrer/i.test(message)) return "í‚¤ ì œí•œ(HTTP referrer) ë•Œë¬¸ì— ì°¨ë‹¨ëœ ê²ƒ ê°™ìŠµë‹ˆë‹¤. GitHub Pages ë„ë©”ì¸ì„ í—ˆìš© ëª©ë¡ì— ì¶”ê°€í•˜ì„¸ìš”.";
    return `YouTube API ì˜¤ë¥˜: ${message}`;
  }

  function ytKey(){ return $("#apiKey").value.trim(); }
  function withKey(u){
    const k = ytKey();
    if(!k) return null;
    const url = new URL(u);
    url.searchParams.set("key", k);
    return url.toString();
  }

  function currentFilters(){
    return {
      len: $("#lenFilter").value,
      period: $("#periodFilter").value,
      sort: $("#sortMode").value,
    };
  }

  function applyFilters(){
    const f = currentFilters();
    const start = getPeriodStart(f.period);

    let out = [...itemsAll];

    // ê¸°ê°„(í´ë¼ì—ì„œë„ ì•ˆì „ í•„í„°)
    if(start){
      out = out.filter(it => {
        const d = it.publishedAt ? new Date(it.publishedAt) : null;
        return d && d >= start;
      });
    }

    // ìˆí¼/ë¡±í¼
    if(f.len !== "all"){
      out = out.filter(it => {
        const s = it.durationSeconds;
        if(!Number.isFinite(s)) return false;
        return f.len === "short" ? (s < 60) : (s >= 60);
      });
    }

    // ì •ë ¬: ì¡°íšŒìˆ˜/ì¢‹ì•„ìš”/êµ¬ë…ì
    const byViews = (a,b)=> (Number(b.viewCount||0) - Number(a.viewCount||0));
    const byLikes = (a,b)=> (Number(b.likeCount||0) - Number(a.likeCount||0));
    const bySubs  = (a,b)=> (Number(b.subscriberCount||0) - Number(a.subscriberCount||0));

    if(f.sort==="views_desc") out.sort(byViews);
    else if(f.sort==="likes_desc") out.sort(byLikes);
    else if(f.sort==="subs_desc") out.sort(bySubs);

    itemsFiltered = out;
    renderList();
    updateCount();
  }

  function updateCount(){
    $("#countPill").innerHTML = `<strong>${fmtNum(itemsFiltered.length)}</strong>ê°œ`;
  }

  function pickThumb(th){
    if(!th) return "";
    return th.maxres?.url || th.high?.url || th.medium?.url || th.default?.url || "";
  }

  function renderList(){
    const list = $("#list");
    list.innerHTML = "";

    if(itemsFiltered.length === 0){
      list.appendChild(Object.assign(document.createElement("div"), {className:"small", textContent:"ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰í•˜ê±°ë‚˜ í•„í„°ë¥¼ ì¡°ì •í•´ë³´ì„¸ìš”."}));
      return;
    }

    // í…Œì´ë¸” ë³´ê¸°(ê°„ë‹¨ í…Œì´ë¸”)
    if(viewMode === "table"){
      const box = document.createElement("div");
      box.className = "panel";
      box.style.borderRadius = "16px";
      box.style.boxShadow = "none";
      box.style.background = "rgba(18,27,59,.45)";

      const hd = document.createElement("div");
      hd.className = "hd";
      hd.style.borderBottom = "1px solid rgba(255,255,255,.10)";
      hd.innerHTML = `<div class="title">í•­ëª© (í´ë¦­: ìƒì„¸)</div>`;

      const bd = document.createElement("div");
      bd.className = "bd";

      itemsFiltered.forEach(it => {
        const row = document.createElement("div");
        row.className = "row";
        row.style.padding = "10px 8px";
        row.style.borderBottom = "1px solid rgba(255,255,255,.08)";
        row.style.cursor = "pointer";
        row.style.alignItems = "flex-start";
        row.addEventListener("click", ()=>{ selected = it; renderDetail(it); });

        row.appendChild(chip("YouTube", "acc"));

        const mid = document.createElement("div");
        mid.style.flex = "1";
        mid.style.minWidth = "240px";
        mid.innerHTML = `
          <div class="titleline">${esc(it.title || "(ì œëª© ì—†ìŒ)")}</div>
          <div class="subline">
            ${esc(it.channelTitle||"-")} Â· ${fmtDate(toDate(it.publishedAt))}
            Â· ğŸ‘€ ${fmtNum(it.viewCount)} Â· ğŸ‘ ${fmtNum(it.likeCount)} Â· ğŸ‘¥ ${fmtNum(it.subscriberCount)}
          </div>
        `;
        row.appendChild(mid);

        row.appendChild(lenChip(it.durationSeconds));

        bd.appendChild(row);
      });

      box.appendChild(hd);
      box.appendChild(bd);
      list.appendChild(box);
      return;
    }

    // ì¹´ë“œ ë³´ê¸°
    itemsFiltered.forEach(it => {
      const card = document.createElement("div");
      card.className = "card";
      card.addEventListener("click", ()=>{ selected = it; renderDetail(it); });

      const th = document.createElement("div");
      th.className = "thumb";
      th.innerHTML = it.thumbnail ? `<img src="${esc(it.thumbnail)}" alt="thumb"/>` : `<div class="small" style="padding:10px">No Image</div>`;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <div class="titleline">${esc(it.title || "(ì œëª© ì—†ìŒ)")}</div>
        <div class="subline">
          <span class="chip acc">YouTube</span>
          <span class="chip">${esc(it.channelTitle||"-")}</span>
          <span class="chip">ì—…ë¡œë“œ ${fmtDate(toDate(it.publishedAt))}</span>
        </div>
        <div class="desc">${esc(clampStr(it.description || "", 180))}</div>
      `;

      const chips = document.createElement("div");
      chips.className = "chips";
      chips.appendChild(lenChip(it.durationSeconds));
      if(it.tags && it.tags.length){
        it.tags.slice(0,4).forEach(t=>chips.appendChild(chip("#"+t)));
      } else {
        chips.appendChild(chip("íƒœê·¸ ì—†ìŒ","bad"));
      }

      const stats = document.createElement("div");
      stats.className = "statrow";
      stats.innerHTML = `
        <span class="stat">ğŸ‘€ ì¡°íšŒìˆ˜ ${fmtNum(it.viewCount)}</span>
        <span class="stat">ğŸ‘ ì¢‹ì•„ìš” ${fmtNum(it.likeCount)}</span>
        <span class="stat">ğŸ‘¥ êµ¬ë…ì ${fmtNum(it.subscriberCount)}</span>
      `;

      meta.appendChild(chips);
      meta.appendChild(stats);

      card.appendChild(th);
      card.appendChild(meta);
      list.appendChild(card);
    });
  }

  // âœ… ìƒì„¸ì—ì„œ ì˜ìƒ ì¬ìƒ(iframe)
  function renderDetail(it){
    const box = $("#detail");
    box.innerHTML = "";

    if(!it){
      box.innerHTML = `<div class="small">ëª©ë¡ì—ì„œ í•­ëª©ì„ í´ë¦­í•˜ë©´ ìƒì„¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>`;
      return;
    }

    const videoId = it.id;

    const header = document.createElement("div");
    header.className = "row";
    header.style.justifyContent = "space-between";
    header.style.alignItems = "flex-start";
    header.style.gap = "12px";

    const left = document.createElement("div");
    left.style.flex = "1";
    left.innerHTML = `
      <div class="detailTitle">${esc(it.title || "(ì œëª© ì—†ìŒ)")}</div>
      <div class="small" style="color:var(--muted)">
        ${esc(it.channelTitle || "-")} Â· ${fmtDate(toDate(it.publishedAt))}
      </div>
    `;

    const right = document.createElement("div");
    right.className = "row";
    right.innerHTML = `
      <a class="btn ghost" href="${esc(it.url||"#")}" target="_blank" rel="noopener">ì›ë³¸ ì—´ê¸° â†—</a>
    `;

    header.appendChild(left);
    header.appendChild(right);

    const player = document.createElement("div");
    player.style.margin = "12px 0";
    player.style.border = "1px solid var(--line)";
    player.style.borderRadius = "16px";
    player.style.overflow = "hidden";
    player.style.background = "rgba(0,0,0,.25)";
    player.innerHTML = `
      <div style="aspect-ratio:16/9; width:100%;">
        <iframe
          src="https://www.youtube.com/embed/${encodeURIComponent(videoId)}"
          title="YouTube player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
          style="width:100%; height:100%; display:block;"
        ></iframe>
      </div>
    `;

    const kv = document.createElement("div");
    kv.className = "kv";
    kv.innerHTML = `
      <div class="k">ê¸¸ì´</div><div class="v">${fmtSeconds(it.durationSeconds)}</div>
      <div class="k">ì¡°íšŒìˆ˜</div><div class="v">${fmtNum(it.viewCount)}</div>
      <div class="k">ì¢‹ì•„ìš”</div><div class="v">${fmtNum(it.likeCount)}</div>
      <div class="k">êµ¬ë…ì</div><div class="v">${fmtNum(it.subscriberCount)}</div>
      <div class="k">ëŒ“ê¸€</div><div class="v">${fmtNum(it.commentCount)}</div>
      <div class="k">íƒœê·¸</div><div class="v">${(it.tags && it.tags.length) ? esc(it.tags.join(", ")) : "ì—†ìŒ"}</div>
    `;

    const desc = document.createElement("div");
    desc.className = "small";
    desc.style.whiteSpace = "pre-wrap";
    desc.style.color = "var(--sub)";
    desc.style.marginTop = "10px";
    desc.textContent = it.description || "";

    box.appendChild(header);
    box.appendChild(player);
    box.appendChild(kv);
    box.appendChild(desc);

    selected = it;
  }

  // CSV(Excel friendly)
  function toCSV(rows){
    if(!rows.length) return "";
    const keys = Object.keys(rows[0]);
    const escCell = (v) => {
      const s = (v==null) ? "" : String(v);
      const t = s.replace(/\r?\n/g, "\\n");
      return `"${t.replace(/"/g,'""')}"`;
    };
    const lines = [];
    lines.push(keys.map(escCell).join(","));
    for(const r of rows){
      lines.push(keys.map(k => escCell(r[k])).join(","));
    }
    return "\uFEFF" + lines.join("\n"); // UTF-8 BOM
  }
  function downloadText(text, filename, mime){
    const blob = new Blob([text], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  }
  function exportExcelCSV(){
    if(!itemsFiltered.length){
      setStatus("ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.", "warn");
      return;
    }
    const rows = itemsFiltered.map(it => ({
      platform: "YouTube",
      title: it.title,
      description: it.description,
      tags: (it.tags||[]).join("|"),
      channelTitle: it.channelTitle,
      channelId: it.channelId,
      publishedAt: it.publishedAt,
      duration: fmtSeconds(it.durationSeconds),
      viewCount: it.viewCount,
      likeCount: it.likeCount,
      commentCount: it.commentCount,
      subscriberCount: it.subscriberCount,
      url: it.url
    }));
    const csv = toCSV(rows);
    const name = `youtube_export_${new Date().toISOString().slice(0,10)}.csv`;
    downloadText(csv, name, "text/csv;charset=utf-8");
    setStatus("CSV ë‹¤ìš´ë¡œë“œ ì‹œì‘", "ok");
  }

  async function fetchVideos(ids){
    const all = [];
    for(let i=0; i<ids.length; i+=50){
      const chunk = ids.slice(i, i+50);
      const u = new URL("https://www.googleapis.com/youtube/v3/videos");
      u.searchParams.set("part", "snippet,statistics,contentDetails");
      u.searchParams.set("id", chunk.join(","));
      const url = withKey(u.toString());
      const res = await fetchJSON(url);
      if(!res.ok){
        showErr(classifyYtError(res));
        return null;
      }
      all.push(...(res.json?.items || []));
    }
    return all;
  }

  async function fetchChannels(ids){
    const map = new Map();
    if(!ids || !ids.length) return map;
    for(let i=0; i<ids.length; i+=50){
      const chunk = ids.slice(i, i+50);
      const u = new URL("https://www.googleapis.com/youtube/v3/channels");
      u.searchParams.set("part", "snippet,statistics");
      u.searchParams.set("id", chunk.join(","));
      const url = withKey(u.toString());
      const res = await fetchJSON(url);
      if(!res.ok){
        showErr(classifyYtError(res));
        return map;
      }
      (res.json?.items || []).forEach(ch => map.set(ch.id, ch));
    }
    return map;
  }

  async function search({direction="new"}={}){
    hideErr(); hideHelp();
    setStatus("ë¡œë”© ì¤‘â€¦", "warn");

    const key = ytKey();
    if(!key){ showErr("YouTube API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”."); setStatus("ëŒ€ê¸°"); return; }

    const q = $("#query").value.trim();
    if(!q){ showErr("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); setStatus("ëŒ€ê¸°"); return; }

    const maxResults = $("#maxResults").value;
    const period = $("#periodFilter").value;
    const start = getPeriodStart(period);

    let pageToken = null;
    if(direction==="next") pageToken = page.next;
    if(direction==="prev") pageToken = page.prev;
    if(direction==="new"){ page.next=null; page.prev=null; pageToken=null; }

    $("#spin").style.display = "";
    $("#searchBtn").disabled = true;

    try{
      // search.list (video)
      const su = new URL("https://www.googleapis.com/youtube/v3/search");
      su.searchParams.set("part", "snippet");
      su.searchParams.set("q", q);
      su.searchParams.set("type", "video");
      su.searchParams.set("maxResults", maxResults);
      if(pageToken) su.searchParams.set("pageToken", pageToken);
      if(start) su.searchParams.set("publishedAfter", start.toISOString());

      const sUrl = withKey(su.toString());
      const sRes = await fetchJSON(sUrl);

      if(!sRes.ok){
        const msg = classifyYtError(sRes);
        showErr(msg);
        if(sRes.status===0){
          showHelp("ë„¤íŠ¸ì›Œí¬/CORSë¡œ ë§‰í˜”ì„ ìˆ˜ ìˆì–´ìš”. GitHub Pages(https)ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ê³ , í‚¤ ì œí•œ(HTTP referrer)ì„ ì ê²€í•´ë³´ì„¸ìš”.");
        }
        setStatus("ì‹¤íŒ¨", "err");
        return;
      }

      const sData = sRes.json || {};
      lastRaw = {step:"search.list", response:sData};

      page.next = sData.nextPageToken || null;
      page.prev = sData.prevPageToken || null;
      $("#nextBtn").disabled = !page.next;
      $("#prevBtn").disabled = !page.prev;

      const videoIds = (sData.items||[]).map(it => it.id?.videoId).filter(Boolean);
      if(videoIds.length === 0){
        itemsAll = [];
        applyFilters();
        renderDetail(null);
        setStatus("ê²°ê³¼ ì—†ìŒ", "warn");
        return;
      }

      // videos.list (tags/statistics/duration)
      const videos = await fetchVideos(videoIds);
      if(!videos){ setStatus("ì‹¤íŒ¨", "err"); return; }

      // channels.list (subscriberCount)
      const channelIds = [...new Set(videos.map(v => v.snippet?.channelId).filter(Boolean))];
      const chMap = await fetchChannels(channelIds);

      // merge
      const unified = videos.map(v => {
        const sn = v.snippet || {};
        const st = v.statistics || {};
        const cd = v.contentDetails || {};
        const dur = parseISODurationToSeconds(cd.duration);
        const ch = chMap.get(sn.channelId) || null;
        const subs = ch ? Number(ch.statistics?.subscriberCount) : null;

        return {
          id: v.id,
          title: sn.title || "",
          description: sn.description || "",
          tags: Array.isArray(sn.tags) ? sn.tags.map(t=>String(t)) : [],
          channelTitle: sn.channelTitle || "",
          channelId: sn.channelId || "",
          publishedAt: sn.publishedAt || null,
          thumbnail: pickThumb(sn.thumbnails),
          url: v.id ? `https://www.youtube.com/watch?v=${encodeURIComponent(v.id)}` : "",
          durationSeconds: Number.isFinite(dur) ? dur : null,
          viewCount: Number(st.viewCount)||0,
          likeCount: Number(st.likeCount)||0,
          commentCount: Number(st.commentCount)||0,
          subscriberCount: Number.isFinite(subs) ? subs : null,
          raw: {video:v, channel:ch}
        };
      });

      itemsAll = unified;
      applyFilters();
      renderDetail(null);
      setStatus(`ì˜ìƒ ${unified.length}ê°œ`, "ok");
      lastRaw = {...lastRaw, step2:"videos.list+channels.list", videos, channels:[...chMap.values()]};

    } finally {
      $("#spin").style.display = "none";
      $("#searchBtn").disabled = false;
    }
  }

  // Events
  const savedKey = localStorage.getItem(LS_KEY);
  if(savedKey) $("#apiKey").value = savedKey;

  $("#saveKeyBtn").addEventListener("click", ()=>{
    localStorage.setItem(LS_KEY, ytKey());
    setStatus("í‚¤ ì €ì¥ ì™„ë£Œ", "ok");
  });
  $("#delKeyBtn").addEventListener("click", ()=>{
    localStorage.removeItem(LS_KEY);
    $("#apiKey").value = "";
    setStatus("í‚¤ ì‚­ì œ ì™„ë£Œ", "ok");
  });

  $("#searchBtn").addEventListener("click", ()=>search({direction:"new"}));
  $("#nextBtn").addEventListener("click", ()=>search({direction:"next"}));
  $("#prevBtn").addEventListener("click", ()=>search({direction:"prev"}));

  $("#applyBtn").addEventListener("click", applyFilters);

  $("#viewToggleBtn").addEventListener("click", ()=>{
    viewMode = (viewMode==="card") ? "table" : "card";
    renderList();
    setStatus(viewMode==="card" ? "ì¹´ë“œ ë³´ê¸°" : "í…Œì´ë¸” ë³´ê¸°", "ok");
  });

  $("#exportBtn").addEventListener("click", exportExcelCSV);

  $("#jsonToggleBtn").addEventListener("click", ()=>{
    const box = $("#jsonBox");
    const show = box.style.display !== "block";
    box.style.display = show ? "block" : "none";
    box.textContent = show ? JSON.stringify(lastRaw ?? {info:"ì•„ì§ ì›ë³¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."}, null, 2) : "";
  });

  $("#copyUrlBtn").addEventListener("click", async ()=>{
    if(!selected?.url){ setStatus("ì„ íƒëœ í•­ëª©/URLì´ ì—†ìŠµë‹ˆë‹¤.", "warn"); return; }
    try{
      await navigator.clipboard.writeText(selected.url);
      setStatus("URL ë³µì‚¬ ì™„ë£Œ", "ok");
    } catch {
      setStatus("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨", "err");
    }
  });

  $("#closeDetailBtn").addEventListener("click", ()=>renderDetail(null));

  $("#resetBtn").addEventListener("click", ()=>{
    itemsAll = [];
    itemsFiltered = [];
    selected = null;
    lastRaw = null;
    page.next = null;
    page.prev = null;
    $("#nextBtn").disabled = true;
    $("#prevBtn").disabled = true;
    $("#jsonBox").style.display = "none";
    $("#jsonBox").textContent = "";
    renderList();
    renderDetail(null);
    updateCount();
    hideErr(); hideHelp();
    setStatus("ì´ˆê¸°í™” ì™„ë£Œ", "ok");
  });

  ["#lenFilter","#periodFilter","#sortMode"].forEach(sel=>{
    $(sel).addEventListener("change", applyFilters);
  });

  // init
  renderList();
  renderDetail(null);
  updateCount();
  setStatus("ëŒ€ê¸°");

})();
</script>

</body>
</html>
