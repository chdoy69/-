<!--
YouTube 채널/영상 검색 & 상세조회 (단일 HTML, 순수 JS/CSS)

[사용법]
1) Google Cloud Console에서 프로젝트 생성 → "YouTube Data API v3" 사용 설정
2) API 키 발급(가능하면 HTTP referrer 제한을 설정)
3) 이 파일(index.html)을 열고, 상단에 API 키 입력 후 저장
4) 검색어 입력 → "검색" 클릭
5) 결과가 있으면 "다운로드" 버튼으로 CSV 저장

[주의]
- search.list 결과에는 tags가 포함되지 않습니다. 이 앱은 검색 후 videoId/channelId를 모아
  videos.list/channels.list를 추가 호출해 tags/통계 등을 합칩니다.
- 일부 환경에서는 file://에서 호출이 제한될 수 있습니다. 가능하면 GitHub Pages 등 https에서 사용하세요.
-->

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube 채널/영상 조회 (YouTube Data API v3)</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#101826;
      --card:#121f33;
      --muted:#8aa0b8;
      --text:#eaf1ff;
      --line:#24364f;
      --good:#4ade80;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(59,130,246,.18), transparent 60%),
                  radial-gradient(900px 500px at 100% 20%, rgba(16,185,129,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, "Malgun Gothic", sans-serif;
      line-height:1.35;
    }
    a{color:#93c5fd; text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1200px; margin:0 auto; padding:22px 16px 64px}
    header{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{display:flex; flex-direction:column; gap:6px;}
    .title h1{font-size:18px; margin:0; letter-spacing:.2px;}
    .title p{margin:0; color:var(--muted); font-size:13px;}

    .toolbar{
      width:100%;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    @media (max-width: 980px){ .toolbar{grid-template-columns:1fr 1fr} }
    @media (max-width: 640px){ .toolbar{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px;}
    .label{
      font-size:12px; color:var(--muted);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    input[type="text"], input[type="password"], select{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0c1422;
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:#5f7894}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}

    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(147,197,253,.18);
      background: linear-gradient(180deg, rgba(59,130,246,.18), rgba(59,130,246,.08));
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn.secondary{
      background: linear-gradient(180deg, rgba(148,163,184,.16), rgba(148,163,184,.06));
      border-color: rgba(148,163,184,.18);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(244,63,94,.18), rgba(244,63,94,.06));
      border-color: rgba(244,63,94,.2);
    }

    .tabs{
      display:flex; gap:8px; align-items:center;
      padding:4px;
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      width:fit-content;
    }
    .tab{
      padding:8px 12px;
      border-radius: 999px;
      font-size:13px;
      color:var(--muted);
      cursor:pointer;
      border:1px solid transparent;
    }
    .tab.active{
      color:var(--text);
      background: rgba(59,130,246,.18);
      border-color: rgba(59,130,246,.25);
    }

    .statusbar{
      margin-top:12px;
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      color:var(--muted);
      font-size:13px;
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.7fr 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel h2{
      margin:0;
      font-size:14px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      color:#cfe0ff;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .panel .body{padding:12px 14px}

    .msg{
      border-radius: 12px;
      border:1px solid var(--line);
      padding:10px 12px;
      background: rgba(255,255,255,.02);
      color: var(--muted);
      white-space:pre-wrap;
    }
    .msg.good{border-color: rgba(74,222,128,.25); color:#bff3d1; background: rgba(74,222,128,.06)}
    .msg.warn{border-color: rgba(251,191,36,.25); color:#ffe2a0; background: rgba(251,191,36,.06)}
    .msg.bad{border-color: rgba(251,113,133,.25); color:#ffd0d8; background: rgba(251,113,133,.06)}

    .spin{
      display:inline-block;
      width:14px; height:14px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.18);
      border-top-color: rgba(147,197,253,.85);
      animation: r 0.8s linear infinite;
      vertical-align:-2px;
      margin-right:8px;
    }
    @keyframes r{to{transform:rotate(360deg)}}

    .cards{display:flex; flex-direction:column; gap:10px;}
    .card{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:12px;
      padding:12px;
      background: rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius: 14px;
      cursor:pointer;
      transition: transform .08s ease, border-color .08s ease, background .08s ease;
    }
    .card:hover{transform: translateY(-1px); border-color: rgba(147,197,253,.25); background: rgba(59,130,246,.06)}
    .thumb{
      width:120px; height:68px; border-radius:12px; overflow:hidden;
      background:#081022;
      border:1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      color:rgba(255,255,255,.35);
      font-size:12px;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .meta{display:flex; flex-direction:column; gap:6px; min-width:0}
    .card .t{
      font-size:14px; margin:0; color:var(--text);
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient: vertical; overflow:hidden;
    }
    .sub{
      font-size:12px; color:var(--muted);
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .desc{
      font-size:12px; color:#b4c6dc;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient: vertical; overflow:hidden;
      opacity:.9;
    }
    .pillrow{display:flex; gap:6px; flex-wrap:wrap; margin-top:4px}
    .pill{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(148,163,184,.06);
      color:#d5e6ff;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px 12px;
      font-size:13px;
      margin:0;
    }
    .k{color:var(--muted)}
    .v{color:var(--text); overflow-wrap:anywhere}
    .hr{height:1px; background:var(--line); margin:12px 0}
    pre{
      margin:0;
      padding:12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#071023;
      max-height: 360px;
      overflow:auto;
      color:#cfe0ff;
      font-size:12px;
    }
    .footerbar{
      margin-top:10px;
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .small{font-size:12px; color:var(--muted)}
    label.row{user-select:none}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>유튜브 채널/영상 조회기 (YouTube Data API v3)</h1>
        <p>검색 → IDs 묶음 조회(videos.list / channels.list) → 태그/통계/상세 합치기</p>
      </div>
      <div class="row">
        <button class="btn secondary" id="helpBtn">도움말</button>
      </div>
    </header>

    <section class="toolbar">
      <div class="field">
        <div class="label"><span>API 키</span><span>로컬 저장 가능</span></div>
        <div class="row" style="gap:8px">
          <input id="apiKey" type="password" placeholder="YouTube Data API 키 입력" autocomplete="off" />
          <button class="btn" id="saveKeyBtn" style="white-space:nowrap">저장</button>
          <button class="btn danger" id="clearKeyBtn" style="white-space:nowrap">삭제</button>
        </div>
        <div class="small">키는 이 브라우저의 로컬스토리지에만 저장됩니다.</div>
      </div>

      <div class="field">
        <div class="label"><span>검색 종류</span><span>탭 선택</span></div>
        <div class="tabs" role="tablist" aria-label="검색 종류">
          <div class="tab active" id="tabVideo" role="tab" aria-selected="true" tabindex="0" data-type="video">영상</div>
          <div class="tab" id="tabChannel" role="tab" aria-selected="false" tabindex="0" data-type="channel">채널</div>
        </div>
      </div>

      <div class="field">
        <div class="label"><span>검색어</span><span>예: AI, 브루</span></div>
        <input id="q" type="text" placeholder="검색어 입력" />
      </div>

      <div class="field">
        <div class="label"><span>옵션</span><span>정렬/개수</span></div>
        <div class="row">
          <select id="order">
            <option value="relevance">관련도</option>
            <option value="date">최신순</option>
            <option value="viewCount">조회수(영상 위주)</option>
            <option value="rating">평점</option>
            <option value="title">제목</option>
          </select>
          <select id="maxResults" style="min-width:120px">
            <option value="10">10개</option>
            <option value="25" selected>25개</option>
            <option value="50">50개</option>
          </select>
        </div>
      </div>

      <div class="field" style="grid-column: 1 / -1">
        <div class="row" style="justify-content:space-between; gap:10px">
          <div class="row">
            <button class="btn" id="searchBtn">검색</button>
            <button class="btn secondary" id="nextBtn" disabled>다음 페이지</button>
            <button class="btn secondary" id="prevBtn" disabled>이전 페이지</button>

            <!-- ✅ 변경: 검색 전에도 항상 보이게 + 항상 클릭 가능 -->
            <button class="btn secondary" id="exportBtn">다운로드</button>
          </div>
          <div class="row">
            <label class="row" style="gap:8px; cursor:pointer;">
              <input id="jsonToggle" type="checkbox" />
              <span class="small">JSON 보기</span>
            </label>
          </div>
        </div>

        <div class="statusbar">
          <div id="statusText">대기 중</div>
          <div class="small" id="countText">결과: -</div>
        </div>

        <div id="message" class="msg" style="margin-top:10px; display:none"></div>
      </div>
    </section>

    <section class="grid">
      <div class="panel">
        <h2>
          <span>결과 목록</span>
          <span class="small" id="resultHint">카드를 클릭하면 상세가 표시됩니다.</span>
        </h2>
        <div class="body">
          <div id="cards" class="cards"></div>
        </div>
      </div>

      <div class="panel">
        <h2>
          <span>상세 패널</span>
          <span class="small" id="detailHint">선택한 항목 없음</span>
        </h2>
        <div class="body">
          <div id="detail" class="msg">왼쪽 목록에서 항목을 선택하세요.</div>
          <div id="jsonWrap" style="display:none; margin-top:12px">
            <div class="hr"></div>
            <div class="small" style="margin-bottom:8px">원본/합쳐진 JSON</div>
            <pre id="jsonPre">{}</pre>
          </div>
        </div>
      </div>
    </section>

    <div class="footerbar">
      <div class="small">
        요청 최적화: <span class="pill">search.list → IDs 모음 → videos.list/channels.list(배치)</span>
      </div>
      <div class="small">
        팁: API 키는 가능한 한 제한(Referrer/IP)하세요.
      </div>
    </div>
  </div>

  <script>
    const YT_BASE = "https://www.googleapis.com/youtube/v3";

    let activeType = "video";
    let pageToken = "";
    let nextPageToken = "";
    let prevPageToken = "";
    let lastCombinedPayload = null;
    let currentResults = [];

    const el = (id) => document.getElementById(id);

    const apiKeyInput = el("apiKey");
    const saveKeyBtn = el("saveKeyBtn");
    const clearKeyBtn = el("clearKeyBtn");

    const tabVideo = el("tabVideo");
    const tabChannel = el("tabChannel");

    const qInput = el("q");
    const orderSel = el("order");
    const maxResultsSel = el("maxResults");

    const searchBtn = el("searchBtn");
    const nextBtn = el("nextBtn");
    const prevBtn = el("prevBtn");
    const exportBtn = el("exportBtn");
    const jsonToggle = el("jsonToggle");

    const statusText = el("statusText");
    const countText = el("countText");
    const messageBox = el("message");
    const cardsWrap = el("cards");

    const detailWrap = el("detail");
    const detailHint = el("detailHint");
    const jsonWrap = el("jsonWrap");
    const jsonPre = el("jsonPre");

    function setMessage(type, text) {
      if (!text) {
        messageBox.style.display = "none";
        messageBox.textContent = "";
        messageBox.className = "msg";
        return;
      }
      messageBox.style.display = "block";
      messageBox.textContent = text;
      messageBox.className = "msg " + (type || "");
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function setStatus(text, spinning=false) {
      statusText.innerHTML = spinning ? `<span class="spin"></span>${escapeHtml(text)}` : escapeHtml(text);
    }

    function fmtDate(iso) {
      if (!iso) return "-";
      try {
        const d = new Date(iso);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd}`;
      } catch { return iso; }
    }

    function parseISODuration(iso) {
      if (!iso || typeof iso !== "string") return "-";
      const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!m) return iso;
      const h = Number(m[1] || 0);
      const min = Number(m[2] || 0);
      const s = Number(m[3] || 0);
      const hh = h > 0 ? String(h).padStart(2,"0") + ":" : "";
      const mm = String(min).padStart(2,"0");
      const ss = String(s).padStart(2,"0");
      return hh + mm + ":" + ss;
    }

    function toNum(n) {
      if (n === undefined || n === null) return null;
      const x = Number(n);
      return Number.isFinite(x) ? x : null;
    }

    function prettyNum(n) {
      const x = toNum(n);
      if (x === null) return "-";
      return x.toLocaleString("ko-KR");
    }

    function pickThumb(snippet) {
      const t = snippet?.thumbnails;
      return t?.medium?.url || t?.high?.url || t?.default?.url || "";
    }

    function getApiKey() {
      return (apiKeyInput.value || "").trim();
    }

    function loadKeyFromStorage() {
      const saved = localStorage.getItem("YT_API_KEY") || "";
      if (saved) apiKeyInput.value = saved;
    }
    function saveKeyToStorage() {
      const k = getApiKey();
      if (!k) { setMessage("warn", "API 키가 비어 있습니다."); return; }
      localStorage.setItem("YT_API_KEY", k);
      setMessage("good", "API 키를 저장했습니다.");
      setTimeout(() => setMessage(null, ""), 1500);
    }
    function clearKeyFromStorage() {
      localStorage.removeItem("YT_API_KEY");
      apiKeyInput.value = "";
      setMessage("good", "API 키를 삭제했습니다.");
      setTimeout(() => setMessage(null, ""), 1500);
    }

    function setActiveTab(type) {
      activeType = type;
      const isVideo = type === "video";
      tabVideo.classList.toggle("active", isVideo);
      tabChannel.classList.toggle("active", !isVideo);
      tabVideo.setAttribute("aria-selected", String(isVideo));
      tabChannel.setAttribute("aria-selected", String(!isVideo));
      el("resultHint").textContent = isVideo
        ? "영상 결과를 클릭하면 태그/통계/길이 등을 확인할 수 있어요."
        : "채널 결과를 클릭하면 구독자/조회수/채널 설명 등을 확인할 수 있어요.";
    }

    async function ytFetch(endpoint, params) {
      const key = getApiKey();
      if (!key) throw new Error("API_KEY_MISSING");

      const url = new URL(YT_BASE + endpoint);
      Object.entries(params || {}).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== "") url.searchParams.set(k, String(v));
      });
      url.searchParams.set("key", key);

      const res = await fetch(url.toString(), { method: "GET" });
      let data = null;
      try { data = await res.json(); } catch {}
      if (!res.ok) {
        const reason = data?.error?.errors?.[0]?.reason || data?.error?.message || ("HTTP_" + res.status);
        const msg = data?.error?.message || "요청 실패";
        const err = new Error(msg);
        err.ytReason = reason;
        err.httpStatus = res.status;
        err.payload = data;
        throw err;
      }
      return data;
    }

    async function searchList({ q, type, order, maxResults, pageToken }) {
      return ytFetch("/search", { part:"snippet", q, type, order, maxResults, pageToken });
    }

    async function videosListByIds(ids) {
      return ytFetch("/videos", { part:"snippet,contentDetails,statistics", id: ids.join(","), maxResults:50 });
    }
    async function channelsListByIds(ids) {
      return ytFetch("/channels", { part:"snippet,statistics,brandingSettings", id: ids.join(","), maxResults:50 });
    }

    function mergeVideoResults(searchItems, videoItems) {
      const byId = new Map();
      for (const v of (videoItems || [])) byId.set(v.id, v);

      const merged = [];
      for (const s of (searchItems || [])) {
        const vid = s?.id?.videoId;
        const v = byId.get(vid);
        const snippet = v?.snippet || s?.snippet || {};
        const tags = Array.isArray(snippet?.tags) ? snippet.tags : [];
        merged.push({
          kind:"video",
          id: vid,
          title: snippet?.title || "(제목 없음)",
          description: snippet?.description || "",
          tags,
          channelTitle: snippet?.channelTitle || "",
          channelId: snippet?.channelId || "",
          publishedAt: snippet?.publishedAt || "",
          thumbnail: pickThumb(snippet),
          url: vid ? `https://www.youtube.com/watch?v=${encodeURIComponent(vid)}` : "",
          categoryId: snippet?.categoryId || "",
          duration: parseISODuration(v?.contentDetails?.duration),
          stats: {
            viewCount: v?.statistics?.viewCount ?? null,
            likeCount: v?.statistics?.likeCount ?? null,
            commentCount: v?.statistics?.commentCount ?? null
          },
          _raw: { search:s, detail:v }
        });
      }
      return merged;
    }

    function mergeChannelResults(searchItems, channelItems) {
      const byId = new Map();
      for (const c of (channelItems || [])) byId.set(c.id, c);

      const merged = [];
      for (const s of (searchItems || [])) {
        const cid = s?.id?.channelId;
        const c = byId.get(cid);
        const snippet = c?.snippet || s?.snippet || {};
        const branding = c?.brandingSettings || {};
        const country = branding?.channel?.country || snippet?.country || "";
        merged.push({
          kind:"channel",
          id: cid,
          title: snippet?.title || "(채널명 없음)",
          description: snippet?.description || "",
          tags: [],
          publishedAt: snippet?.publishedAt || "",
          thumbnail: pickThumb(snippet),
          url: cid ? `https://www.youtube.com/channel/${encodeURIComponent(cid)}` : "",
          customUrl: snippet?.customUrl || "",
          country: country || "",
          stats: {
            subscriberCount: c?.statistics?.subscriberCount ?? null,
            viewCount: c?.statistics?.viewCount ?? null,
            videoCount: c?.statistics?.videoCount ?? null
          },
          _raw: { search:s, detail:c }
        });
      }
      return merged;
    }

    function renderCards(list) {
      cardsWrap.innerHTML = "";
      if (!list || list.length === 0) {
        cardsWrap.innerHTML = `<div class="msg">결과가 없습니다. 검색어를 바꾸거나 옵션을 조정해보세요.</div>`;
        return;
      }

      for (const item of list) {
        const thumb = item.thumbnail
          ? `<img src="${escapeHtml(item.thumbnail)}" alt="thumbnail" loading="lazy" />`
          : `No Image`;

        const pills = [];
        if (item.kind === "video") {
          if (item.duration && item.duration !== "-") pills.push(`길이: ${item.duration}`);
          if (item.categoryId) pills.push(`카테고리: ${item.categoryId}`);
          if (item.stats?.viewCount != null) pills.push(`조회수: ${prettyNum(item.stats.viewCount)}`);
          (item.tags || []).slice(0,3).forEach(t => pills.push(`#${t}`));
        } else {
          if (item.stats?.subscriberCount != null) pills.push(`구독자: ${prettyNum(item.stats.subscriberCount)}`);
          if (item.stats?.viewCount != null) pills.push(`조회수: ${prettyNum(item.stats.viewCount)}`);
          if (item.stats?.videoCount != null) pills.push(`영상수: ${prettyNum(item.stats.videoCount)}`);
          if (item.customUrl) pills.push(item.customUrl);
          if (item.country) pills.push(`국가: ${item.country}`);
        }

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="thumb">${thumb}</div>
          <div class="meta">
            <p class="t">${escapeHtml(item.title)}</p>
            <div class="sub">
              <span>게시: ${escapeHtml(fmtDate(item.publishedAt))}</span>
              ${item.kind === "video"
                ? `<span>채널: ${escapeHtml(item.channelTitle || "-")}</span>`
                : `<span>채널ID: ${escapeHtml(item.id || "-")}</span>`
              }
            </div>
            <div class="desc">${escapeHtml(item.description || "")}</div>
            <div class="pillrow">
              ${pills.slice(0,8).map(p => `<span class="pill" title="${escapeHtml(p)}">${escapeHtml(p)}</span>`).join("")}
            </div>
          </div>
        `;
        card.addEventListener("click", () => renderDetail(item));
        cardsWrap.appendChild(card);
      }
    }

    function renderDetail(item) {
      detailHint.textContent = item.kind === "video" ? "영상 상세" : "채널 상세";
      const tags = (item.tags || []);
      const tagText = tags.length ? tags.join(", ") : "(없음 또는 제공되지 않음)";

      if (item.kind === "video") {
        detailWrap.innerHTML = `
          <div style="font-weight:700; margin-bottom:6px">${escapeHtml(item.title)}</div>
          <div class="small" style="margin-bottom:10px">
            채널: ${escapeHtml(item.channelTitle || "-")} · 게시일: ${escapeHtml(fmtDate(item.publishedAt))} · 길이: ${escapeHtml(item.duration || "-")}
          </div>
          <div class="row" style="margin-bottom:10px">
            <a class="btn secondary" href="${escapeHtml(item.url)}" target="_blank" rel="noreferrer">유튜브 열기</a>
          </div>
          <div class="hr"></div>
          <div class="kv">
            <div class="k">videoId</div><div class="v">${escapeHtml(item.id)}</div>
            <div class="k">태그(tags)</div><div class="v">${escapeHtml(tagText)}</div>
            <div class="k">categoryId</div><div class="v">${escapeHtml(item.categoryId || "-")}</div>
            <div class="k">조회수</div><div class="v">${prettyNum(item.stats?.viewCount)}</div>
            <div class="k">좋아요</div><div class="v">${prettyNum(item.stats?.likeCount)}</div>
            <div class="k">댓글수</div><div class="v">${prettyNum(item.stats?.commentCount)}</div>
            <div class="k">설명</div><div class="v">${escapeHtml(item.description || "-")}</div>
          </div>
        `;
      } else {
        detailWrap.innerHTML = `
          <div style="font-weight:700; margin-bottom:6px">${escapeHtml(item.title)}</div>
          <div class="small" style="margin-bottom:10px">
            생성일: ${escapeHtml(fmtDate(item.publishedAt))} ${item.country ? " · 국가: " + escapeHtml(item.country) : ""}
          </div>
          <div class="row" style="margin-bottom:10px">
            <a class="btn secondary" href="${escapeHtml(item.url)}" target="_blank" rel="noreferrer">채널 열기</a>
          </div>
          <div class="hr"></div>
          <div class="kv">
            <div class="k">channelId</div><div class="v">${escapeHtml(item.id)}</div>
            <div class="k">customUrl</div><div class="v">${escapeHtml(item.customUrl || "-")}</div>
            <div class="k">구독자</div><div class="v">${prettyNum(item.stats?.subscriberCount)}</div>
            <div class="k">조회수</div><div class="v">${prettyNum(item.stats?.viewCount)}</div>
            <div class="k">영상수</div><div class="v">${prettyNum(item.stats?.videoCount)}</div>
            <div class="k">설명</div><div class="v">${escapeHtml(item.description || "-")}</div>
            <div class="k">태그</div><div class="v">(채널 태그는 API 기본 응답에서 제공되지 않는 경우가 많습니다)</div>
          </div>
        `;
      }

      if (jsonToggle.checked && lastCombinedPayload) {
        jsonWrap.style.display = "block";
        jsonPre.textContent = JSON.stringify({ selected: item._raw, combined: lastCombinedPayload }, null, 2);
      } else {
        jsonWrap.style.display = "none";
        jsonPre.textContent = "{}";
      }
    }

    function renderJsonGlobal() {
      if (!jsonToggle.checked) {
        jsonWrap.style.display = "none";
        jsonPre.textContent = "{}";
        return;
      }
      jsonWrap.style.display = "block";
      jsonPre.textContent = JSON.stringify(lastCombinedPayload || {}, null, 2);
    }

    function downloadCSV(rows, filename) {
      const csv = rows.map(r => r.map(cell => {
        const s = String(cell ?? "");
        const needsQuote = /[",\n\r]/.test(s);
        const escaped = s.replaceAll('"', '""');
        return needsQuote ? `"${escaped}"` : escaped;
      }).join(",")).join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportCurrentToCSV() {
      // ✅ 결과가 없어도 버튼은 항상 눌림 → 여기서 안내
      if (!currentResults || currentResults.length === 0) {
        setMessage("warn", "내보낼 결과가 없습니다. 먼저 검색을 실행하세요.");
        return;
      }
      const isVideo = currentResults[0]?.kind === "video";
      const headers = isVideo
        ? ["kind","videoId","title","channelTitle","channelId","publishedAt","duration","categoryId","viewCount","likeCount","commentCount","tags","url","description"]
        : ["kind","channelId","title","publishedAt","subscriberCount","viewCount","videoCount","country","customUrl","url","description"];

      const rows = [headers];
      for (const it of currentResults) {
        if (isVideo) {
          rows.push([
            it.kind,
            it.id,
            it.title,
            it.channelTitle,
            it.channelId,
            it.publishedAt,
            it.duration,
            it.categoryId,
            it.stats?.viewCount ?? "",
            it.stats?.likeCount ?? "",
            it.stats?.commentCount ?? "",
            (it.tags || []).join("|"),
            it.url,
            it.description
          ]);
        } else {
          rows.push([
            it.kind,
            it.id,
            it.title,
            it.publishedAt,
            it.stats?.subscriberCount ?? "",
            it.stats?.viewCount ?? "",
            it.stats?.videoCount ?? "",
            it.country ?? "",
            it.customUrl ?? "",
            it.url,
            it.description
          ]);
        }
      }
      const stamp = new Date().toISOString().slice(0,19).replaceAll(":","").replace("T","_");
      downloadCSV(rows, `youtube_${isVideo ? "videos" : "channels"}_${stamp}.csv`);
    }

    async function runSearch({ resetPage = true } = {}) {
      setMessage(null, "");
      detailHint.textContent = "선택한 항목 없음";
      detailWrap.textContent = "왼쪽 목록에서 항목을 선택하세요.";
      jsonWrap.style.display = "none";

      const q = (qInput.value || "").trim();
      if (!q) { setMessage("warn", "검색어를 입력하세요."); return; }
      if (!getApiKey()) { setMessage("warn", "API 키를 입력하고 저장하세요."); return; }

      if (resetPage) pageToken = "";
      const order = orderSel.value;
      const maxResults = maxResultsSel.value;

      try {
        setStatus("검색 중...", true);
        searchBtn.disabled = true;
        nextBtn.disabled = true;
        prevBtn.disabled = true;
        cardsWrap.innerHTML = `<div class="msg"><span class="spin"></span>불러오는 중...</div>`;

        const searchPayload = await searchList({ q, type: activeType, order, maxResults, pageToken });

        nextPageToken = searchPayload?.nextPageToken || "";
        prevPageToken = searchPayload?.prevPageToken || "";
        nextBtn.disabled = !nextPageToken;
        prevBtn.disabled = !prevPageToken;

        const items = searchPayload?.items || [];
        if (items.length === 0) {
          currentResults = [];
          lastCombinedPayload = { search: searchPayload, details: null, merged: [] };
          renderCards([]);
          renderJsonGlobal();
          countText.textContent = "결과: 0";
          setStatus("완료");
          return;
        }

        let detailsPayload = null;
        let merged = [];

        if (activeType === "video") {
          const ids = items.map(x => x?.id?.videoId).filter(Boolean);
          detailsPayload = await videosListByIds(ids.slice(0, 50));
          merged = mergeVideoResults(items, detailsPayload?.items || []);
        } else {
          const ids = items.map(x => x?.id?.channelId).filter(Boolean);
          detailsPayload = await channelsListByIds(ids.slice(0, 50));
          merged = mergeChannelResults(items, detailsPayload?.items || []);
        }

        currentResults = merged;
        lastCombinedPayload = { search: searchPayload, details: detailsPayload, merged };

        renderCards(merged);
        renderJsonGlobal();
        countText.textContent = `결과: ${merged.length}`;
        setStatus("완료");
      } catch (err) {
        console.error(err);
        setMessage(...Object.values(friendlyError(err)));
        cardsWrap.innerHTML = `<div class="msg bad">오류가 발생했습니다. 상단 메시지를 확인하세요.</div>`;
        setStatus("오류");
      } finally {
        searchBtn.disabled = false;
      }
    }

    function friendlyError(err) {
      const reason = err?.ytReason || "";
      const status = err?.httpStatus;

      if (err?.message === "API_KEY_MISSING" || reason === "keyInvalid") {
        return { 0: "bad", 1: "API 키가 없거나 유효하지 않습니다. 키를 확인하세요." };
      }
      if (reason === "quotaExceeded" || reason === "dailyLimitExceeded") {
        return { 0: "bad", 1: "할당량(Quota)을 초과했습니다. 내일 다시 시도하거나 다른 키를 사용하세요." };
      }
      if (reason === "accessNotConfigured") {
        return { 0: "bad", 1: "YouTube Data API v3가 활성화되지 않았습니다. 콘솔에서 API 사용 설정을 확인하세요." };
      }
      if (reason === "keyRestricted") {
        return { 0: "bad", 1: "API 키 제한(Referrer/IP) 때문에 호출이 거부되었습니다. 제한 설정을 확인하세요." };
      }
      if (status === 403) {
        return { 0: "bad", 1: "권한 문제(403)입니다. API 활성화/키 제한/할당량 등을 확인하세요." };
      }
      if (String(err?.message || "").toLowerCase().includes("failed to fetch")) {
        return { 0: "warn", 1: "네트워크 요청이 실패했습니다. (CORS/네트워크 문제 가능) GitHub Pages(https)에서 실행 중인지 확인하세요." };
      }
      return { 0: "bad", 1: `오류: ${err?.message || "알 수 없는 오류"} (reason: ${reason || "-"})` };
    }

    function showHelp() {
      const msg = `
[GitHub Pages로 실행 추천]
- file://(로컬 파일)보다 https(Pages)에서 실행이 안정적입니다.

[API 키 체크리스트]
1) YouTube Data API v3 사용 설정(Enable)
2) 키 제한(HTTP referrer)에 Pages 주소 추가
   예: https://내아이디.github.io/* 또는 https://내아이디.github.io/저장소명/*
3) API 제한에서 YouTube Data API v3만 허용
      `.trim();

      setMessage("warn", msg);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // 이벤트
    saveKeyBtn.addEventListener("click", saveKeyToStorage);
    clearKeyBtn.addEventListener("click", clearKeyFromStorage);
    el("helpBtn").addEventListener("click", showHelp);

    tabVideo.addEventListener("click", () => setActiveTab("video"));
    tabChannel.addEventListener("click", () => setActiveTab("channel"));
    tabVideo.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") setActiveTab("video"); });
    tabChannel.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") setActiveTab("channel"); });

    searchBtn.addEventListener("click", () => runSearch({ resetPage: true }));
    qInput.addEventListener("keydown", (e) => { if (e.key === "Enter") runSearch({ resetPage: true }); });

    nextBtn.addEventListener("click", () => { if (!nextPageToken) return; pageToken = nextPageToken; runSearch({ resetPage: false }); });
    prevBtn.addEventListener("click", () => { if (!prevPageToken) return; pageToken = prevPageToken; runSearch({ resetPage: false }); });

    exportBtn.addEventListener("click", exportCurrentToCSV);

    jsonToggle.addEventListener("change", renderJsonGlobal);

    // 초기화
    loadKeyFromStorage();
    setActiveTab("video");
    setStatus("대기 중");
    setMessage(null, "");
  </script>
</body>
</html>
